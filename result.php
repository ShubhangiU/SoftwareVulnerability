<?php
if(isset($_POST['submit'])){
	$table_col = $_POST['mail'];

 $conn = mysqli_connect ('localhost', 'root', '');
if (!$conn) {
  die('Not connected : ' . mysqli_error());
}
 mysqli_select_db($conn,"jsondb"); 

$query = "select * from insertjson where project_name = '$table_col'";
$records = mysqli_query($conn, $query);
//echo $records;
$query1 = "SELECT COUNT(CASE WHEN `severity` LIKE '%Minor%' THEN 1 END) from insertjson where project_name = '$table_col' ";
$records1 = mysqli_query($conn, $query1);
$row = mysqli_fetch_row($records1); 
$r1 = implode(', ', $row);
//echo $r1;

$query2 = "SELECT COUNT(CASE WHEN `severity` LIKE '%Major%' THEN 1 END) as major from insertjson where project_name = '$table_col'  ";
$records2 = mysqli_query($conn, $query2);
$row1 = mysqli_fetch_row($records2); 
$r2 = implode(', ', $row1);
$query3 = "SELECT COUNT(CASE WHEN `severity` LIKE '%Critical%' THEN 1 END) as critical from insertjson where project_name = '$table_col' ";
$records3 = mysqli_query($conn, $query3);
$row2 = mysqli_fetch_row($records3); 
$r3 = implode(', ', $row2);
$query4 = "SELECT COUNT(CASE WHEN `severity` LIKE '%Blocker%' THEN 1 END) as blocker from insertjson where project_name = '$table_col'  ";
$records4 = mysqli_query($conn, $query4);
$row3 = mysqli_fetch_row($records4); 
$r4 = implode(', ', $row3);
$dataPoints = array(
	array("label"=> "Minor", "y"=> $r1),
	array("label"=> "Major", "y"=> $r2),
	array("label"=> "Critical", "y"=> $r3),
	array("label"=> "Blocker", "y"=> $r4),
	
	
);
}
?>
<html>
<head>
<script>
window.onload = function () {
 
var chart = new CanvasJS.Chart("chartContainer", {
	animationEnabled: true,
	exportEnabled: true,
	title:{
		text: "Severity of Application"
	},
	subtitles: [{
		text: "Severity depends on maximun % share"
	}],
	data: [{
		type: "pie",
		showInLegend: "true",
		legendText: "{label}",
		indexLabelFontSize: 16,
		indexLabel: "{label} - #percent%",
		yValueFormatString: "à¸¿#,##0",
		dataPoints: <?php echo json_encode($dataPoints, JSON_NUMERIC_CHECK); ?>
	}]
});
chart.render();
 
}
</script>
<style>
table {
  font-family: arial, sans-serif;
  border-collapse: collapse;
  width: 100%;
}

td, th {
  border: 1px solid #dddddd;
  text-align: left;
  padding: 8px;
}

tr:nth-child(even) {
  background-color: #dddddd;
}
</style>
</head>
<body>

<h2>Application Analysis</h2>

<table>
  <tr>
    <th>Issue Message</th>
    <th>Severity</th>
    <th>CVE ID</th>
	<th> CWE ID</th>
	<th>Score</th>
	<th>Vulnerability Type</th>
  </tr>
 <?php

while($data = mysqli_fetch_array($records)) :?>
	 <tr>
	<td><?php echo $data['issue_message']; ?></td>
	<td><?php echo $data['severity']; ?></td>
	<td><?php echo $data['CVE_id']; ?></td>
	<td><?php echo $data['CWE_id']; ?></td>
	<td><?php echo $data['score']; ?></td>
	<td><?php echo $data['vulnerability_type']; ?></td>
	
</form></td>
	
<?php endwhile; ?>
</tr>

</table>
<div id="chartContainer" style="height: 370px; width: 100%;"></div>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

</body>
</html>
